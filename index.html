<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hits-ster by Karin</title>
    <!-- Elegant Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f4c2c2; /* Soft Pink / Rose Gold */
            --accent: #a881af; /* Dusty Lavender */
            --bg-dark: #0f0d11; /* Warm Midnight */
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 182, 193, 0.15);
            --text-main: #f0e6e6; /* Soft Off-White */
            --text-muted: #9b8a8a; /* Warm Gray */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            background: radial-gradient(circle at center, #1a151b 0%, #0f0d11 100%);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            padding: 20px;
        }

        /* Abstract Background Elements */
        .bg-glow {
            position: fixed;
            width: 50vw;
            height: 50vw;
            background: radial-gradient(circle, rgba(244, 194, 194, 0.08) 0%, transparent 70%);
            top: -15%;
            right: -10%;
            z-index: -1;
            filter: blur(80px);
        }

        .bg-glow-2 {
            position: fixed;
            width: 40vw;
            height: 40vw;
            background: radial-gradient(circle, rgba(168, 129, 175, 0.05) 0%, transparent 70%);
            bottom: -10%;
            left: -5%;
            z-index: -1;
            filter: blur(80px);
        }

        /* Container & Cards */
        .container {
            width: 100%;
            max-width: 550px;
            perspective: 1000px;
            z-index: 10;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 45px;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6);
            animation: float 8s ease-in-out infinite;
            position: relative;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Typography */
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin: 0 0 10px 0;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            color: var(--primary);
            margin-bottom: 35px;
            display: block;
            font-weight: 600;
            opacity: 0.8;
        }

        /* Inputs & Buttons */
        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: block;
        }

        input, select {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 14px 18px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.4s ease;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            background: rgba(244, 194, 194, 0.05);
            box-shadow: 0 0 20px rgba(244, 194, 194, 0.05);
        }

        button {
            background: var(--text-main);
            color: var(--bg-dark);
            border: none;
            border-radius: 100px;
            padding: 18px 30px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            width: 100%;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            background: #fff;
        }

        button.ghost {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-main);
        }

        button.pink {
            background: var(--primary);
            color: #402020;
        }

        /* Game Elements */
        .player-tag {
            background: rgba(244, 194, 194, 0.08);
            padding: 8px 16px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            font-size: 0.75rem;
            margin: 5px;
            display: inline-block;
            transition: 0.3s;
        }

        #statusText {
            font-size: 0.85rem;
            color: var(--primary);
            font-style: italic;
            height: 20px;
            margin: 15px 0;
            opacity: 0.7;
        }

        .checkbox-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 24px;
            padding: 24px;
            margin: 20px 0;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 14px 0;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            margin-right: 15px;
            accent-color: var(--primary);
            border: 1px solid var(--glass-border);
        }

        /* Scoreboard Footer */
        .scoreboard {
            margin-top: 35px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .score-item {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .score-item b { color: var(--primary); font-size: 0.85rem; }

        /* Helpers */
        .hidden { display: none !important; }
        #player-wrapper { position: absolute; left: -9999px; }

        /* Modal Overlay */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 13, 17, 0.85);
            backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-box {
            background: #151218;
            padding: 45px;
            border-radius: 35px;
            border: 1px solid var(--glass-border);
            max-width: 380px;
            width: 90%;
            text-align: center;
        }

        .song-link {
            display: inline-block;
            margin: 20px 0;
            font-size: 0.75rem;
            color: var(--primary);
            text-decoration: none;
            opacity: 0.6;
            transition: 0.3s;
        }
        .song-link:hover { opacity: 1; transform: scale(1.05); }

        .rules {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.8;
            margin-top: 30px;
            opacity: 0.8;
        }

        #modeInfo {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 700;
        }

    </style>
</head>
<body>

<div class="bg-glow"></div>
<div class="bg-glow-2"></div>
<div id="player-wrapper"><div id="youtube-player"></div></div>

<!-- Custom Confirmation Modal -->
<div id="modal-overlay" class="hidden">
    <div class="modal-box">
        <h3 id="modal-title" style="font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-top:0;">Reset Game?</h3>
        <p id="modal-body" style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px;">This will dissolve all progress.</p>
        <button onclick="confirmModalAction()" class="pink">Confirm Reset</button>
        <button onclick="closeModal()" class="ghost" style="margin-top: 15px;">Continue Playing</button>
    </div>
</div>

<div class="container">
    <div class="card">
        <!-- SETUP PHASE -->
        <div id="setup">
            <h1>Hits-ster</h1>
            <span class="subtitle">by Karin</span>
            
            <div class="input-group">
                <label>Players (Max 10)</label>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="pName" placeholder="Name" autocomplete="off">
                    <button onclick="addPlayer()" style="width: auto; margin:0; padding: 0 25px; height: 50px;">+</button>
                </div>
                <div id="pList" style="margin-top: 20px; min-height: 40px;"></div>
            </div>

            <div class="input-group">
                <label>Game Era</label>
                <select id="decadeFilter">
                    <option value="all">Across All Decades</option>
                    <option value="60s">The 1960s</option>
                    <option value="70s">The 1970s</option>
                    <option value="80s">The 1980s</option>
                    <option value="90s">The 1990s</option>
                    <option value="00s">The 2000s</option>
                    <option value="10s">The 2010s</option>
                    <option value="20s">The 2020s</option>
                </select>
            </div>

            <div class="input-group">
                <label>Focus Artist</label>
                <input type="text" id="artistFilter" list="artistList" placeholder="e.g. Fleetwood Mac">
                <datalist id="artistList"></datalist>
            </div>

            <div class="input-group">
                <label>Custom Playlist</label>
                <input type="text" id="customUrl" placeholder="YouTube Link...">
                <button id="applyCustomBtn" onclick="applyCustomPlaylist()" class="hidden ghost" style="font-size: 0.65rem; padding: 8px; margin-top: 10px;">Connect Playlist</button>
                <div id="customStatus" style="font-size: 0.65rem; margin-top: 8px; color: var(--primary);"></div>
            </div>

            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px;">
                <button onclick="checkFilters()" class="ghost" style="width: auto; font-size: 0.65rem; padding: 10px 20px;">Check Library</button>
                <span id="filterCount" style="font-size: 0.75rem; font-weight: 600; color: var(--accent);"></span>
            </div>

            <button id="startBtn" class="hidden pink" onclick="startGame()">Rock On</button>

            <div class="rules">
                Reach 10 points. On your turn, listen and name 2 out of 3 details correctly to gain a point.
            </div>
        </div>

        <!-- GAME PHASE -->
        <div id="game" class="hidden">
            <div id="modeInfo"></div>
            <h2 id="turnTxt" style="font-family: 'Playfair Display', serif; font-size: 2.2rem; margin: 0 0 8px 0;"></h2>
            <p id="deckInfo" style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 30px; letter-spacing: 1px;"></p>
            
            <div id="playPhase">
                <p id="statusText"></p>
                <button id="loadBtn" onclick="playRandomSong()" class="pink">Next Track</button>
                
                <div id="controls" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <button onclick="toggleAudio()" class="ghost" id="pauseBtn" style="margin:0;">‚ñ∂ Play</button>
                    <button onclick="showResults()" class="pink" style="margin:0;">Reveal</button>
                </div>
            </div>

            <div id="results" class="hidden">
                <h3 id="resTitle" style="font-family: 'Playfair Display', serif; font-size: 2rem; margin: 15px 0 5px 0;"></h3>
                <p id="resArtist" style="color: var(--text-muted); margin: 0 0 20px 0; font-size: 1rem;"></p>
                <div id="resYear" style="font-size: 3.2rem; font-weight: 800; color: var(--primary); margin-bottom: 25px; letter-spacing: -2px;"></div>
                
                <div class="checkbox-container">
                    <label class="checkbox-item"><input type="checkbox" class="sc-check"> Track Name</label>
                    <label class="checkbox-item"><input type="checkbox" class="sc-check"> Artist Name</label>
                    <label class="checkbox-item"><input type="checkbox" class="sc-check"> Original Year</label>
                </div>
                
                <a id="songLink" href="#" target="_blank" class="song-link">Play song on YouTube ‚Üó</a>
                
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button onclick="submitTurn()" class="pink" style="flex: 2;">Continue Journey</button>
                    <button onclick="toggleAudio()" class="ghost" id="resultsPauseBtn" style="flex: 1; padding: 18px 0; font-size: 0.65rem;">‚ñ∂ Resume</button>
                </div>
            </div>

            <div id="sb" class="scoreboard"></div>
            <button onclick="triggerReset()" class="ghost" style="margin-top: 50px; font-size: 0.6rem; border: none; color: #444; letter-spacing: 2px;">End Session</button>
        </div>

        <!-- WIN SCREEN -->
        <div id="winScreen" class="hidden">
            <h1 style="font-size: 5rem; margin-bottom: 10px;">üëë</h1>
            <h2 id="winnerName" style="font-family: 'Playfair Display', serif; font-size: 2rem; margin: 0; line-height: 1.4;"></h2>
            <p style="letter-spacing: 3px; text-transform: uppercase; color: var(--primary); margin-top: 25px; font-weight: 700; font-size: 0.8rem;">The Ultimate Hitster</p>
            <button onclick="location.reload()" class="pink" style="margin-top: 50px;">New Beginning</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'hitster_karin_rose_v8_final';

    // YouTube API Load
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    let isPlayerReady = false;
    let retryCount = 0;
    let customPlaylistId = null;
    let isPlaylistStarted = false;
    let modalCallback = null;
    let isResultsScreen = false;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            height: '100', width: '100', videoId: '',
            playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0, 'autoplay': 1 },
            events: {
                'onReady': (e) => { isPlayerReady = true; e.target.setVolume(100); },
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerStateChange(event) {
        const btn = document.getElementById('pauseBtn');
        const rBtn = document.getElementById('resultsPauseBtn');
        const st = document.getElementById('statusText');
        
        if (event.data === YT.PlayerState.PLAYING) {
            st.innerText = isResultsScreen ? "" : "Playing...";
            btn.innerText = "‚è∏ Pause";
            rBtn.innerText = "‚è∏ Pause";
            retryCount = 0;
            if (player.getCurrentTime() < 5) player.seekTo(45);
        } else if (event.data === YT.PlayerState.PAUSED) {
            btn.innerText = "‚ñ∂ Play";
            rBtn.innerText = "‚ñ∂ Resume";
            if (!isResultsScreen) st.innerText = ""; 
        } else if (event.data === YT.PlayerState.BUFFERING) {
            st.innerText = "Sorry, ads...";
        }
    }

    function onPlayerError(event) {
        if (retryCount < 3) {
            retryCount++;
            document.getElementById('statusText').innerText = "Static detected. Retrying...";
            setTimeout(playRandomSong, 1500); 
        } else {
            document.getElementById('statusText').innerText = "Signal lost.";
            document.getElementById('loadBtn').classList.remove('hidden');
        }
    }

    function openModal(title, body, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerText = body;
        document.getElementById('modal-overlay').classList.remove('hidden');
        modalCallback = callback;
    }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
    function confirmModalAction() { if (modalCallback) modalCallback(); closeModal(); }

    const playlist = [
        // 1960s
        { n: "Hey Jude", a: "The Beatles", y: 1968, id: "A_MjCqQoLLA" },
        { n: "Respect", a: "Aretha Franklin", y: 1967, id: "6FOUqQt3Kg0" },
        { n: "Good Vibrations", a: "The Beach Boys", y: 1966, id: "Eab_beh07HU" },
        { n: "Stand by Me", a: "Ben E. King", y: 1961, id: "hwZNL7QVJjE" },
        { n: "Satisfaction", a: "The Rolling Stones", y: 1965, id: "nrIPxlFzDi0" },
        // 1970s
        { n: "Bohemian Rhapsody", a: "Queen", y: 1975, id: "fJ9rUzIMcZQ" },
        { n: "Hotel California", a: "Eagles", y: 1976, id: "vced7_ySgV8" },
        { n: "Dreams", a: "Fleetwood Mac", y: 1977, id: "Y3ywicffOj4" },
        { n: "September", a: "Earth, Wind & Fire", y: 1978, id: "Gs069dndIYk" },
        { n: "Stayin' Alive", a: "Bee Gees", y: 1977, id: "I_izvAbhExY" },
        // 1980s
        { n: "Billie Jean", a: "Michael Jackson", y: 1982, id: "Zi_XLOBDo_Y" },
        { n: "Take On Me", a: "a-ha", y: 1984, id: "djV11Xbc914" },
        { n: "Sweet Child O' Mine", a: "Guns N' Roses", y: 1987, id: "1w7OgIMMRc4" },
        { n: "Purple Rain", a: "Prince", y: 1984, id: "TvnYmWpD_T8" },
        { n: "Livin' on a Prayer", a: "Bon Jovi", y: 1986, id: "lDK99Y4qsEk" },
        // 1990s
        { n: "Smells Like Teen Spirit", a: "Nirvana", y: 1991, id: "hTWKbfoikeg" },
        { n: "Wonderwall", a: "Oasis", y: 1995, id: "6hzrDeceEKc" },
        { n: "Losing My Religion", a: "R.E.M.", y: 1991, id: "xwtdhWltSIg" },
        { n: "No Scrubs", a: "TLC", y: 1999, id: "FrLequ6dUdM" },
        { n: "Baby One More Time", a: "Britney Spears", y: 1998, id: "C-u5WLJ9Yk4" },
        // 2000s
        { n: "Mr. Brightside", a: "The Killers", y: 2003, id: "gGdGFtwCNBE" },
        { n: "Toxic", a: "Britney Spears", y: 2003, id: "LOZuxwVk7TU" },
        { n: "Hey Ya!", a: "Outkast", y: 2003, id: "PWgvGjAhvIw" },
        { n: "Poker Face", a: "Lady Gaga", y: 2008, id: "bESGLojNYSo" },
        { n: "Lose Yourself", a: "Eminem", y: 2002, id: "_Yhyp-_hX2s" },
        // 2010s
        { n: "Rolling in the Deep", a: "Adele", y: 2011, id: "rYEDA3JcQqw" },
        { n: "Uptown Funk", a: "Bruno Mars", y: 2014, id: "OPf0YbXqDm0" },
        { n: "Shape of You", a: "Ed Sheeran", y: 2017, id: "JGwWNGJdvx8" },
        { n: "Bad Guy", a: "Billie Eilish", y: 2019, id: "DyDfgMOUjCI" },
        { n: "Blinding Lights", a: "The Weeknd", y: 2019, id: "4NRXx6U8ABQ" },
        // 2020s
        { n: "Flowers", a: "Miley Cyrus", y: 2023, id: "G7KNmW9a75Y" },
        { n: "As It Was", a: "Harry Styles", y: 2022, id: "H5v3kku4y6Q" },
        { n: "Anti-Hero", a: "Taylor Swift", y: 2022, id: "b1kbLwvqugk" },
        { n: "Espresso", a: "Sabrina Carpenter", y: 2024, id: "ep2f_eHnQfI" },
        { n: "Vampire", a: "Olivia Rodrigo", y: 2023, id: "RlPNh_PBZb4" }
    ];

    let players = [];
    let cur = 0;
    let deck = [];
    let currentSong = null;
    let currentModeText = "All Eras"; 
    
    document.addEventListener('DOMContentLoaded', () => {
        const decIn = document.getElementById('decadeFilter');
        const artIn = document.getElementById('artistFilter');
        const urlIn = document.getElementById('customUrl');
        artIn.addEventListener('input', () => { if (artIn.value.trim()) { decIn.value = 'all'; customPlaylistId = null; checkFilters(); } });
        decIn.addEventListener('change', () => { if (decIn.value !== 'all') { artIn.value = ''; customPlaylistId = null; checkFilters(); } });
        urlIn.addEventListener('input', () => { 
            if (urlIn.value.includes('list=')) {
                document.getElementById('applyCustomBtn').classList.remove('hidden');
            } else {
                document.getElementById('applyCustomBtn').classList.add('hidden');
                customPlaylistId = null;
            }
        });
        populateArtistList();
        loadState();
    });

    function applyCustomPlaylist() {
        const url = document.getElementById('customUrl').value;
        const match = url.match(/[&?]list=([^&]+)/);
        if (match && match[1]) {
            customPlaylistId = match[1];
            document.getElementById('customStatus').innerText = "Stream Linked";
            document.getElementById('startBtn').classList.remove('hidden');
        }
    }

    function saveState() {
        const state = { players, cur, deck, currentSong, gameStarted: !document.getElementById('game').classList.contains('hidden'), modeText: currentModeText, customPlaylistId };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        try {
            const state = JSON.parse(raw);
            players = state.players || [];
            cur = state.cur || 0;
            deck = state.deck || [];
            currentSong = state.currentSong || null;
            currentModeText = state.modeText || "All Eras";
            customPlaylistId = state.customPlaylistId || null;
            if(players.length > 0) renderPlayers();
            if(state.gameStarted && players.length > 0) {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('game').classList.remove('hidden');
                document.getElementById('modeInfo').innerText = `Horizon: ${currentModeText}`;
                updateBoard(); updateDeckInfo();
                if (currentSong) {
                    document.getElementById('loadBtn').classList.add('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                }
            }
        } catch(e) {}
    }

    function populateArtistList() {
        const artists = [...new Set(playlist.map(s => s.a))].sort();
        document.getElementById('artistList').innerHTML = artists.map(a => `<option value="${a}">`).join('');
    }

    function addPlayer() {
        if(players.length >= 10) return;
        let n = document.getElementById('pName').value.trim();
        if(n) {
            players.push({ name: n, score: 0 });
            document.getElementById('pName').value = '';
            renderPlayers(); saveState(); 
        }
    }

    function renderPlayers() {
        document.getElementById('pList').innerHTML = players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
        if(players.length >= 1) document.getElementById('startBtn').classList.remove('hidden');
    }

    function checkFilters() {
        if (customPlaylistId) { document.getElementById('filterCount').innerText = "Stream Ready"; return; }
        const matches = getFilteredSongs();
        document.getElementById('filterCount').innerText = `${matches.length} tracks found`;
    }

    function getFilteredSongs() {
        const decade = document.getElementById('decadeFilter').value;
        const artist = document.getElementById('artistFilter').value.toLowerCase().trim();
        return playlist.filter(song => {
            if (artist) return song.a.toLowerCase().includes(artist);
            if (decade !== 'all') {
                const y = parseInt(song.y);
                if (decade === '60s') return y >= 1960 && y < 1970;
                if (decade === '70s') return y >= 1970 && y < 1980;
                if (decade === '80s') return y >= 1980 && y < 1990;
                if (decade === '90s') return y >= 1990 && y < 2000;
                if (decade === '00s') return y >= 2000 && y < 2010;
                if (decade === '10s') return y >= 2010 && y < 2020;
                if (decade === '20s') return y >= 2020;
            }
            return true;
        });
    }

    function startGame() {
        if(!isPlayerReady || players.length === 0) return;
        if (customPlaylistId) {
            currentModeText = "Custom Session";
        } else {
            let pool = getFilteredSongs();
            if (pool.length === 0) return;
            const artist = document.getElementById('artistFilter').value;
            const decade = document.getElementById('decadeFilter').value;
            currentModeText = artist ? `Focus: ${artist}` : (decade !== 'all' ? `Decade: ${decade}` : "All Eras");
            deck = pool.sort(() => Math.random() - 0.5); 
        }
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        document.getElementById('modeInfo').innerText = `Horizon: ${currentModeText}`;
        updateBoard(); updateDeckInfo(); saveState(); 
    }

    function updateDeckInfo() {
        document.getElementById('deckInfo').innerText = customPlaylistId ? `Source: Global Stream` : `Pool: ${deck.length} tracks remaining`;
    }

    function updateBoard() {
        document.getElementById('turnTxt').innerText = players[cur].name;
        document.getElementById('sb').innerHTML = players.map(p => `<div class="score-item">${p.name} <b>${p.score}</b></div>`).join('');
    }

    function playRandomSong() {
        if(!isPlayerReady) return;
        isResultsScreen = false;
        document.getElementById('results').classList.add('hidden');
        document.getElementById('statusText').innerText = "Sorry, ads...";
        if(player && player.stopVideo) player.stopVideo();

        if (customPlaylistId) {
            if (!isPlaylistStarted) {
                player.setLoop(true);
                player.setShuffle(true);
                player.cuePlaylist({ list: customPlaylistId, listType: 'playlist', index: 0, startSeconds: 45 });
                setTimeout(() => { 
                    player.playVideo(); 
                    setTimeout(() => player.nextVideo(), 800);
                }, 1200);
                isPlaylistStarted = true;
            } else { 
                player.nextVideo(); 
            }
            document.getElementById('loadBtn').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('pauseBtn').innerText = "‚ñ∂ Play";
        } else {
            if(deck.length === 0) deck = getFilteredSongs().sort(() => Math.random() - 0.5);
            currentSong = deck.pop();
            updateDeckInfo(); saveState(); 
            player.loadVideoById({ videoId: currentSong.id, startSeconds: 45 });
            document.getElementById('loadBtn').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('pauseBtn').innerText = "‚ñ∂ Play";
        }
    }

    function toggleAudio() { player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo(); }

    function showResults() {
        isResultsScreen = true;
        player.pauseVideo();
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('statusText').innerText = "";
        
        const songLink = document.getElementById('songLink');
        if (customPlaylistId) {
            const data = player.getVideoData();
            const ft = data.title || "Untitled";
            let artist = data.author || "Unknown", name = ft, year = "----";
            if (ft.includes(" - ")) [artist, name] = ft.split(" - ");
            const ym = ft.match(/\b(19|20)\d{2}\b/);
            if (ym) year = ym[0];
            document.getElementById('resTitle').innerText = name.trim();
            document.getElementById('resArtist').innerText = artist.trim();
            document.getElementById('resYear').innerText = year;
            songLink.href = player.getVideoUrl();
        } else if (currentSong) {
            document.getElementById('resTitle').innerText = currentSong.n;
            document.getElementById('resArtist').innerText = currentSong.a;
            document.getElementById('resYear').innerText = currentSong.y;
            songLink.href = `https://www.youtube.com/watch?v=${currentSong.id}`;
        }
    }

    function submitTurn() {
        if(document.querySelectorAll('.sc-check:checked').length >= 2) players[cur].score++;
        
        if(players[cur].score >= 10) {
            document.getElementById('game').classList.add('hidden');
            document.getElementById('winScreen').classList.remove('hidden');
            document.getElementById('winnerName').innerText = `Congratulations ${players[cur].name}! You are a queen!`;
            localStorage.removeItem(STORAGE_KEY); 
            return;
        }

        document.querySelectorAll('.sc-check').forEach(c => c.checked = false);
        cur = (cur + 1) % players.length;
        
        if (!customPlaylistId) player.stopVideo();
        isResultsScreen = false;
        document.getElementById('results').classList.add('hidden');
        document.getElementById('loadBtn').classList.remove('hidden');
        currentSong = null; 
        updateBoard(); saveState(); 
    }

    function triggerReset() {
        openModal("Reset Game?", "All scores will be lost in the night.", () => {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        });
    }
</script>
</body>
</html>
