<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üèÜ Family Hitster</title>
    <style>
        :root { --spotify-green: #1DB954; --bg: #121212; --card: #181818; --curtain: #ff69b4; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 20px; -webkit-tap-highlight-color: transparent; }
        
        .card { background: var(--card); padding: 25px; border-radius: 20px; max-width: 500px; margin: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #333; position: relative; }
        
        h1 { margin-bottom: 20px; font-weight: 800; }
        .accent { color: var(--spotify-green); }
        
        button { background: var(--spotify-green); border: none; padding: 16px 25px; color: white; border-radius: 30px; font-weight: bold; cursor: pointer; margin: 10px 0; width: 100%; font-size: 16px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #333; }
        button.danger { background: transparent; border: 1px solid #444; color: #888; width: auto; font-size: 12px; margin-top: 30px; }
        
        input { width: 85%; padding: 12px; border-radius: 10px; border: 1px solid #444; margin-bottom: 10px; background: #222; color: white; font-size: 16px; }
        
        .hidden { display: none !important; }
        
        /* VIDEO PLAYER WRAPPER */
        #player-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
        }
        
        /* The Actual YouTube Iframe */
        #youtube-player {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        
        /* The Pink Curtain */
        #curtain {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--curtain);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .play-icon {
            font-size: 40px;
            background: rgba(0,0,0,0.2);
            width: 70px; height: 70px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 3px solid white;
            margin-bottom: 10px;
        }

        .checkbox-group { text-align: left; background: #222; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .checkbox-group label { display: flex; align-items: center; margin: 10px 0; font-size: 16px; cursor: pointer; }
        input[type="checkbox"] { width: 22px; height: 22px; margin-right: 15px; accent-color: var(--spotify-green); }

        #statusText { font-size: 12px; color: #888; min-height: 20px; margin-top: 5px; }
        
        .score-badge { display: inline-block; background: #333; padding: 5px 10px; border-radius: 10px; margin: 3px; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <!-- SETUP SCREEN -->
    <div id="setup">
        <h1>üéµ Family <span class="accent">Hitster</span></h1>
        <p style="color:#888;">Add players to start!</p>
        <input type="text" id="pName" placeholder="Player Name" autocomplete="off">
        <button onclick="addPlayer()">Add Player</button>
        <div id="pList" style="margin: 15px 0;"></div>
        <button id="startBtn" class="hidden" onclick="startGame()" style="background: white; color: black;">Start Game</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game" class="hidden">
        <h2 id="turnTxt" class="accent" style="margin-top: 0;"></h2>
        
        <!-- YOUTUBE BOX + CURTAIN -->
        <div id="player-wrapper">
            <div id="youtube-player"></div>
            <!-- This covers the video -->
            <div id="curtain" onclick="manualPlay()">
                <div class="play-icon">‚ñ∂</div>
                <span style="font-weight: bold; font-size: 16px;">Tap Here to Play</span>
            </div>
        </div>

        <!-- PHASE 1: PLAYING -->
        <div id="playPhase">
            <button id="loadBtn" onclick="playRandomSong()">üé≤ Load Next Song</button>
            <p id="statusText"></p>
            
            <div id="controls" class="hidden">
                <button onclick="toggleAudio()" class="secondary" id="pauseBtn" style="width: 48%; display: inline-block;">‚è∏ Pause</button>
                <button onclick="showResults()" style="width: 48%; display: inline-block; background: var(--spotify-green);">2. Show Results</button>
            </div>
        </div>

        <!-- PHASE 2: RESULTS -->
        <div id="results" class="hidden">
            <h2 id="resTitle" style="margin: 5px 0;"></h2>
            <p id="resArtist" style="color: #aaa; margin: 0; font-size: 1.2em;"></p>
            <h1 id="resYear" class="accent" style="margin: 10px 0;"></h1>
            
            <div class="checkbox-group">
                <p style="margin: 0 0 10px 0; color: #aaa; font-size: 14px;">Mark correct answers (2+ for point):</p>
                <label><input type="checkbox" class="sc-check"> Song Name</label>
                <label><input type="checkbox" class="sc-check"> Artist</label>
                <label><input type="checkbox" class="sc-check"> Year</label>
            </div>
            
            <button onclick="submitTurn()">Confirm & Next Turn</button>
        </div>

        <div id="sb" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; font-size: 14px; color: #888;"></div>
        <button onclick="confirmReset()" class="danger">Reset Game</button>
    </div>
</div>

<script>
    // --- STORAGE KEY ---
    const STORAGE_KEY = 'family_hitster_save_v1';

    // --- YOUTUBE API SETUP ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    let isPlayerReady = false;
    let retryCount = 0;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            height: '100%',
            width: '100%',
            videoId: '',
            playerVars: { 'playsinline': 1, 'controls': 0, 'fs': 0, 'rel': 0, 'modestbranding': 1 },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        isPlayerReady = true;
        event.target.setVolume(100);
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            document.getElementById('loadBtn').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Playing...";
            document.getElementById('pauseBtn').innerText = "‚è∏ Pause";
            retryCount = 0;
        }
    }

    function onPlayerError(event) {
        console.log("Video Error: " + event.data);
        if (retryCount < 3) {
            retryCount++;
            document.getElementById('statusText').innerText = "Video blocked/deleted. Shuffling to next...";
            setTimeout(playRandomSong, 1500); 
        } else {
            document.getElementById('statusText').innerText = "Connection issue. Tap pink square to retry.";
            document.getElementById('loadBtn').classList.remove('hidden');
            retryCount = 0;
        }
    }

    // --- GAME DATA: VERIFIED HITS ---
    const playlist = [
        { n: "Bohemian Rhapsody", a: "Queen", y: 1975, id: "fJ9rUzIMcZQ" },
        { n: "Imagine", a: "John Lennon", y: 1971, id: "YkgkThdzX-8" },
        { n: "Billie Jean", a: "Michael Jackson", y: 1982, id: "Zi_XLOBDo_Y" },
        { n: "Stayin' Alive", a: "Bee Gees", y: 1977, id: "I_izvAbhExY" },
        { n: "Dancing Queen", a: "ABBA", y: 1976, id: "xFrGuyw1V8s" },
        { n: "Hotel California", a: "Eagles", y: 1976, id: "09839DpTctU" },
        { n: "Sweet Child O' Mine", a: "Guns N' Roses", y: 1987, id: "1w7OgIMMRc4" },
        { n: "Smells Like Teen Spirit", a: "Nirvana", y: 1991, id: "hTWKbfoikeg" },
        { n: "Like a Rolling Stone", a: "Bob Dylan", y: 1965, id: "IwOfCgkyEj0" },
        { n: "I Will Always Love You", a: "Whitney Houston", y: 1992, id: "3JWTaaS7LdU" },
        { n: "Rolling in the Deep", a: "Adele", y: 2011, id: "rYEDA3JcQqw" },
        { n: "Shape of You", a: "Ed Sheeran", y: 2017, id: "JGwWNGJdvx8" },
        { n: "Uptown Funk", a: "Mark Ronson ft. Bruno Mars", y: 2014, id: "OPf0YbXqDm0" },
        { n: "Wonderwall", a: "Oasis", y: 1995, id: "6hzrDeceEKc" },
        { n: "Hey Jude", a: "The Beatles", y: 1968, id: "A_MjCqQoLLA" },
        { n: "Hallelujah", a: "Jeff Buckley", y: 1994, id: "y8AWFf7EAc4" },
        { n: "Eye of the Tiger", a: "Survivor", y: 1982, id: "btPJPFnesV4" },
        { n: "Africa", a: "Toto", y: 1982, id: "FTQbiNvZqaY" },
        { n: "Take on Me", a: "a-ha", y: 1985, id: "djV11Xbc914" },
        { n: "Livin' on a Prayer", a: "Bon Jovi", y: 1986, id: "lDK9QqIzhwk" },
        { n: "Girls Just Want to Have Fun", a: "Cyndi Lauper", y: 1983, id: "PIb6AZdTr-A" },
        { n: "Every Breath You Take", a: "The Police", y: 1983, id: "OMOGaugKpzs" },
        { n: "Respect", a: "Aretha Franklin", y: 1967, id: "6FOUqQt3Kg0" },
        { n: "Superstition", a: "Stevie Wonder", y: 1972, id: "0CFuCYNx-1g" },
        { n: "Purple Rain", a: "Prince", y: 1984, id: "TVNk2qOT3_E" },
        { n: "Lose Yourself", a: "Eminem", y: 2002, id: "_Yhyp-_hX2s" },
        { n: "Single Ladies", a: "Beyonc√©", y: 2008, id: "4m1EFMoRFvY" },
        { n: "Rehab", a: "Amy Winehouse", y: 2006, id: "KUmZp8pR1uc" },
        { n: "Blinding Lights", a: "The Weeknd", y: 2019, id: "4NRXx6U8ABQ" },
        { n: "Flowers", a: "Miley Cyrus", y: 2023, id: "G7KNmW9a75Y" },
        { n: "Heroes", a: "David Bowie", y: 1977, id: "lXgkuM2NhYI" },
        { n: "Wannabe", a: "Spice Girls", y: 1996, id: "gJLIiF15wjQ" },
        { n: "I Want to Hold Your Hand", a: "The Beatles", y: 1963, id: "jenWdylTtzs" },
        { n: "Vogue", a: "Madonna", y: 1990, id: "GuJQSAiODqI" },
        { n: "Jolene", a: "Dolly Parton", y: 1973, id: "Ixrje2rXLMA" },
        { n: "Creep", a: "Radiohead", y: 1992, id: "XFkzRNyygfk" },
        { n: "Thriller", a: "Michael Jackson", y: 1982, id: "sOnqjkJTMaA" },
        { n: "Umbrella", a: "Rihanna", y: 2007, id: "CvBfHwUxHIk" },
        { n: "No Woman, No Cry", a: "Bob Marley", y: 1974, id: "IT8XvxIfldk" },
        { n: "I Will Survive", a: "Gloria Gaynor", y: 1978, id: "ARt9HV9T0w8" },
        { n: "Someone Like You", a: "Adele", y: 2011, id: "hLQl3WQQoQ0" },
        { n: "Toxic", a: "Britney Spears", y: 2003, id: "LOZuxwVk7TU" },
        { n: "Shake It Off", a: "Taylor Swift", y: 2014, id: "nfWlot6h_JM" },
        { n: "Go Your Own Way", a: "Fleetwood Mac", y: 1977, id: "6ul-cZyuYq4" },
        { n: "Piano Man", a: "Billy Joel", y: 1973, id: "gxEPV4kolz0" },
        { n: "Seven Nation Army", a: "The White Stripes", y: 2003, id: "0J2QdDbelmY" },
        { n: "Mr. Brightside", a: "The Killers", y: 2004, id: "gGdGFtwCNBE" },
        { n: "Beat It", a: "Michael Jackson", y: 1982, id: "oRdxUFDoQe0" },
        { n: "Under Pressure", a: "Queen & David Bowie", y: 1981, id: "a01QQZyl-_I" },
        { n: "Sweet Home Alabama", a: "Lynyrd Skynyrd", y: 1974, id: "ye5BuYf8q4o" }
    ];

    let players = [];
    let cur = 0;
    let deck = [];
    let currentSong = null;

    // --- SAVE/LOAD SYSTEM ---
    function saveState() {
        const state = {
            players: players,
            cur: cur,
            deck: deck,
            gameStarted: !document.getElementById('game').classList.contains('hidden')
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        
        try {
            const state = JSON.parse(raw);
            players = state.players || [];
            cur = state.cur || 0;
            deck = state.deck || [];
            
            if(players.length > 0) renderPlayers();

            // If game was already running, skip setup and show game screen
            if(state.gameStarted && players.length > 0) {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('game').classList.remove('hidden');
                updateBoard();
                // We reset to the "Load Song" phase to avoid trying to auto-resume video
                document.getElementById('results').classList.add('hidden');
                document.getElementById('controls').classList.add('hidden');
                document.getElementById('loadBtn').classList.remove('hidden');
            }
        } catch(e) { console.error("Save Error", e); }
    }

    // --- GAME LOGIC ---

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function addPlayer() {
        let n = document.getElementById('pName').value.trim();
        if(n) {
            players.push({ name: n, score: 0 });
            document.getElementById('pName').value = '';
            renderPlayers();
            saveState(); // SAVE
        }
    }

    function renderPlayers() {
        let html = players.map(p => `<span class="score-badge">${p.name}</span>`).join(' ');
        document.getElementById('pList').innerHTML = html;
        if(players.length > 0) document.getElementById('startBtn').classList.remove('hidden');
    }

    function startGame() {
        if(!isPlayerReady) { alert("YouTube player loading... please wait."); return; }
        // Only shuffle new deck if we don't have one (e.g. new game)
        if(deck.length === 0) deck = shuffle([...playlist]);
        
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        updateBoard();
        saveState(); // SAVE
    }

    function updateBoard() {
        document.getElementById('turnTxt').innerText = players[cur].name + "'s Turn";
        document.getElementById('sb').innerHTML = "<b>SCOREBOARD</b><br>" + 
            players.map(p => `${p.name}: ${p.score}`).join(' | ');
    }

    function playRandomSong() {
        // Reset UI
        document.getElementById('results').classList.add('hidden');
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('curtain').style.display = 'flex'; 
        document.getElementById('statusText').innerText = "Loading Video...";
        
        if(player && player.stopVideo) player.stopVideo();

        // Deck Management with Logic
        if(deck.length === 0) {
            let lastSongId = currentSong ? currentSong.id : null;
            deck = shuffle([...playlist]);
            // Ensure we don't repeat the very last song immediately
            if(deck[deck.length-1].id === lastSongId) {
                let temp = deck[0];
                deck[0] = deck[deck.length-1];
                deck[deck.length-1] = temp;
            }
        }
        
        currentSong = deck.pop();
        saveState(); // SAVE (deck changed)

        if(player && player.loadVideoById) {
            player.unMute();
            player.setVolume(100);
            player.loadVideoById({videoId: currentSong.id, startSeconds: 40});
        }
    }

    function manualPlay() {
        if(player && player.playVideo) player.playVideo();
    }

    function toggleAudio() {
        let s = player.getPlayerState();
        if(s === 1) { 
            player.pauseVideo(); 
            document.getElementById('pauseBtn').innerText = "‚ñ∂ Play"; 
        } else { 
            player.playVideo(); 
            document.getElementById('pauseBtn').innerText = "‚è∏ Pause"; 
        }
    }

    function showResults() {
        player.pauseVideo();
        document.getElementById('curtain').style.display = 'none'; 
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('results').classList.remove('hidden');
        
        document.getElementById('resTitle').innerText = currentSong.n;
        document.getElementById('resArtist').innerText = "By: " + currentSong.a;
        document.getElementById('resYear').innerText = currentSong.y;
    }

    function submitTurn() {
        let checks = document.querySelectorAll('.sc-check:checked').length;
        if(checks >= 2) players[cur].score++;
        
        if(players[cur].score >= 10) {
            alert(players[cur].name + " WINS!");
            localStorage.removeItem(STORAGE_KEY); // Clear save on win
            location.reload();
            return;
        }

        // Cleanup
        document.querySelectorAll('.sc-check').forEach(c => c.checked = false);
        cur = (cur + 1) % players.length;
        
        player.stopVideo();
        document.getElementById('results').classList.add('hidden');
        document.getElementById('loadBtn').classList.remove('hidden');
        document.getElementById('curtain').style.display = 'flex'; 
        document.getElementById('statusText').innerText = "";
        
        updateBoard();
        saveState(); // SAVE (score changed)
    }

    function confirmReset() {
        if(confirm("Restart game?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // Initialize Save System
    loadState();
</script>
</body>
</html>
