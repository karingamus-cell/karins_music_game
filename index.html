<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üèÜ Family Hitster</title>
    <style>
        :root { --spotify-green: #1DB954; --bg: #121212; --card: #181818; --curtain: #ff69b4; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 20px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        .card { background: var(--card); padding: 25px; border-radius: 20px; max-width: 500px; margin: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #333; position: relative; z-index: 10; }
        
        h1 { margin-bottom: 20px; font-weight: 800; }
        .accent { color: var(--spotify-green); }
        
        button { background: var(--spotify-green); border: none; padding: 16px 25px; color: white; border-radius: 30px; font-weight: bold; cursor: pointer; margin: 10px 0; width: 100%; font-size: 16px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #333; }
        button.danger { background: transparent; border: 1px solid #444; color: #888; width: auto; font-size: 12px; margin-top: 30px; }
        button.small-btn { padding: 8px 16px; font-size: 14px; width: auto; margin-top: 5px; background: #444; }
        
        input, select { width: 85%; padding: 12px; border-radius: 10px; border: 1px solid #444; margin-bottom: 10px; background: #222; color: white; font-size: 16px; }
        select { width: 92%; cursor: pointer; }

        .hidden { display: none !important; }
        
        /* VIDEO PLAYER - MOVED OFF-SCREEN */
        #player-wrapper {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 200px;
            height: 200px;
            pointer-events: none;
        }
        
        #youtube-player {
            width: 100%;
            height: 100%;
        }

        .checkbox-group { text-align: left; background: #222; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .checkbox-group label { display: flex; align-items: center; margin: 10px 0; font-size: 16px; cursor: pointer; }
        input[type="checkbox"] { width: 22px; height: 22px; margin-right: 15px; accent-color: var(--spotify-green); }

        #statusText { font-size: 14px; color: var(--spotify-green); min-height: 20px; margin-bottom: 10px; font-weight: bold; }
        
        .score-badge { display: inline-block; background: #333; padding: 5px 10px; border-radius: 10px; margin: 3px; font-size: 12px; }

        .filter-box {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #333;
            text-align: left;
        }
        .filter-label { font-size: 12px; color: #888; margin-bottom: 5px; display: block; font-weight: bold; }
        #filterCount { font-size: 13px; color: var(--spotify-green); margin-left: 10px; font-weight: bold; }
        
        #modeInfo {
            font-size: 14px;
            color: #aaa;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        /* CUSTOM MODAL */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-box {
            background: #181818;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #333;
            max-width: 300px;
            width: 80%;
        }

        .rules-box {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 13px;
            color: #888;
            line-height: 1.5;
        }

        .song-link {
            display: block;
            margin: 15px 0;
            color: #aaa;
            text-decoration: none;
            font-size: 13px;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s;
        }
        .song-link:hover { color: var(--spotify-green); }
    </style>
</head>
<body>

<div id="player-wrapper">
    <div id="youtube-player"></div>
</div>

<!-- Custom Confirmation Modal -->
<div id="modal-overlay" class="hidden">
    <div class="modal-box">
        <h3 id="modal-title">Reset Game?</h3>
        <p id="modal-body" style="color: #888; font-size: 14px;">All scores and progress will be lost.</p>
        <button onclick="confirmModalAction()">Yes, Reset</button>
        <button onclick="closeModal()" class="secondary">Cancel</button>
    </div>
</div>

<div class="card">
    <div id="setup">
        <h1>üéµ Family <span class="accent">Hitster</span></h1>
        <p style="color:#888;">1. Add players</p>
        <input type="text" id="pName" placeholder="Enter Player Name" autocomplete="off">
        <button onclick="addPlayer()">Add Player</button>
        <div id="pList" style="margin: 15px 0;"></div>
        
        <div class="filter-box">
            <p style="color:#888; margin-bottom: 10px;">2. Game Mode</p>
            
            <label class="filter-label">Filter by Decade:</label>
            <select id="decadeFilter">
                <option value="all">üé≤ All Time (Default)</option>
                <option value="60s">60s (1960-1969)</option>
                <option value="70s">70s (1970-1979)</option>
                <option value="80s">80s (1980-1989)</option>
                <option value="90s">90s (1990-1999)</option>
                <option value="00s">2000s (2000-2009)</option>
                <option value="10s">2010s+</option>
            </select>

            <div style="text-align: center; color: #555; margin: 10px 0; font-size: 12px;">‚Äî OR ‚Äî</div>

            <label class="filter-label">Filter by Artist:</label>
            <input type="text" id="artistFilter" list="artistList" placeholder="e.g. Queen (Resets decade)" style="width: 85%;">
            <datalist id="artistList"></datalist>

            <div style="text-align: center; color: #555; margin: 10px 0; font-size: 12px;">‚Äî OR ‚Äî</div>

            <label class="filter-label">Custom YouTube Playlist:</label>
            <input type="text" id="customUrl" placeholder="Paste Playlist URL here" style="width: 85%;">
            <button id="applyCustomBtn" onclick="applyCustomPlaylist()" class="small-btn hidden">Apply Playlist</button>
            <div id="customStatus" style="font-size: 12px; margin-top: 5px; color: #888;"></div>

            <div style="margin-top: 20px; display: flex; align-items: center; justify-content: space-between;">
                <button onclick="checkFilters()" class="small-btn">Apply & Check</button>
                <span id="filterCount"></span>
            </div>
        </div>

        <button id="startBtn" class="hidden" onclick="startGame()" style="background: white; color: black; margin-top: 20px;">Start Game</button>

        <div class="rules-box">
            <strong style="color: var(--spotify-green);">How to Play:</strong><br>
            Pick the players and play the songs. If you get 2 out of 3 answers correct, you get a point. First user to reach 10 points is the winner!
        </div>
    </div>

    <div id="game" class="hidden">
        <h2 id="turnTxt" class="accent" style="margin-top: 0; margin-bottom: 5px;"></h2>
        <div id="modeInfo"></div>
        <p id="deckInfo" style="font-size: 11px; color: #666; margin-top: -5px; margin-bottom: 15px;"></p>
        
        <div id="playPhase">
            <p id="statusText"></p>
            <button id="loadBtn" onclick="playRandomSong()">üé≤ Load Next Song</button>
            
            <div id="controls" class="hidden">
                <button onclick="toggleAudio()" class="secondary" id="pauseBtn" style="width: 48%; display: inline-block;">‚ñ∂ Play</button>
                <button onclick="showResults()" style="width: 48%; display: inline-block; background: var(--spotify-green);">2. Show Results</button>
            </div>
        </div>

        <div id="results" class="hidden">
            <h2 id="resTitle" style="margin: 5px 0;"></h2>
            <p id="resArtist" style="color: #aaa; margin: 0; font-size: 1.2em;"></p>
            <h1 id="resYear" class="accent" style="margin: 10px 0;"></h1>
            
            <div class="checkbox-group">
                <p style="margin: 0 0 10px 0; color: #aaa; font-size: 14px;">Mark correct answers (2+ for point):</p>
                <label><input type="checkbox" class="sc-check"> Song Name</label>
                <label><input type="checkbox" class="sc-check"> Artist</label>
                <label><input type="checkbox" class="sc-check"> Year</label>
            </div>
            
            <a id="songLink" href="#" target="_blank" class="song-link">üîó View on YouTube</a>
            
            <button onclick="submitTurn()">Confirm & Next Turn</button>
        </div>

        <div id="sb" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; font-size: 14px; color: #888;"></div>
        <button onclick="triggerReset()" class="danger">Reset Game</button>
    </div>

    <div id="winScreen" class="hidden">
        <h1 style="font-size: 60px; margin-bottom: 10px;">üèÜ</h1>
        <h2 class="accent" id="winnerName" style="margin-top: 0;"></h2>
        <p>is the winner!</p>
        <button onclick="location.reload()" style="margin-top: 30px;">Start New Game</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'family_hitster_save_v21';

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    let player;
    let isPlayerReady = false;
    let retryCount = 0;
    let customPlaylistId = null;
    let isPlaylistStarted = false;
    let modalCallback = null;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            height: '100%',
            width: '100%',
            videoId: '',
            playerVars: { 
                'playsinline': 1, 
                'controls': 0, 
                'fs': 0, 
                'rel': 0, 
                'modestbranding': 1,
                'autoplay': 1 
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        isPlayerReady = true;
        event.target.setVolume(100);
    }

    function onPlayerStateChange(event) {
        const btn = document.getElementById('pauseBtn');
        if (event.data === YT.PlayerState.PLAYING) {
            document.getElementById('statusText').innerText = "üéµ Now Playing...";
            btn.innerText = "‚è∏ Pause";
            retryCount = 0;
            if (player.getCurrentTime() < 10) player.seekTo(40);
        } else if (event.data === YT.PlayerState.PAUSED) {
            btn.innerText = "‚ñ∂ Play";
            document.getElementById('statusText').innerText = "Paused";
        } else if (event.data === YT.PlayerState.BUFFERING) {
            document.getElementById('statusText').innerText = "Buffering...";
        } else if (event.data === YT.PlayerState.ENDED) {
            btn.innerText = "‚ñ∂ Play Again";
        }
    }

    function onPlayerError(event) {
        if (retryCount < 3) {
            retryCount++;
            document.getElementById('statusText').innerText = "Issue with song. Trying next...";
            setTimeout(playRandomSong, 1500); 
        } else {
            document.getElementById('statusText').innerText = "Song unavailable. Try another.";
            document.getElementById('loadBtn').classList.remove('hidden');
            retryCount = 0;
        }
    }

    // Modal System
    function openModal(title, body, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerText = body;
        document.getElementById('modal-overlay').classList.remove('hidden');
        modalCallback = callback;
    }
    function closeModal() {
        document.getElementById('modal-overlay').classList.add('hidden');
    }
    function confirmModalAction() {
        if (modalCallback) modalCallback();
        closeModal();
    }

    const playlist = [
        { n: "Shake It Off", a: "Taylor Swift", y: 2014, id: "nfWlot6h_JM" },
        { n: "Love Story", a: "Taylor Swift", y: 2008, id: "8xg3vE8Ie_E" },
        { n: "Blank Space", a: "Taylor Swift", y: 2014, id: "e-ORhEE9VVg" },
        { n: "Anti-Hero", a: "Taylor Swift", y: 2022, id: "b1kbLwvqugk" },
        { n: "Cruel Summer", a: "Taylor Swift", y: 2019, id: "ic8j13piAhQ" },
        { n: "You Belong With Me", a: "Taylor Swift", y: 2008, id: "VuNIsY6JdUw" },
        { n: "I Knew You Were Trouble", a: "Taylor Swift", y: 2012, id: "vNoKguSdy4Y" },
        { n: "22", a: "Taylor Swift", y: 2012, id: "AgFeZr5ptV8" },
        { n: "Look What You Made Me Do", a: "Taylor Swift", y: 2017, id: "3tmd-ClpJxA" },
        { n: "Billie Jean", a: "Michael Jackson", y: 1982, id: "Zi_XLOBDo_Y" },
        { n: "Thriller", a: "Michael Jackson", y: 1982, id: "sOnqjkJTMaA" },
        { n: "Beat It", a: "Michael Jackson", y: 1982, id: "oRdxUFDoQe0" },
        { n: "Bohemian Rhapsody", a: "Queen", y: 1975, id: "fJ9rUzIMcZQ" },
        { n: "Don't Stop Me Now", a: "Queen", y: 1978, id: "HgzGwKwLmgM" },
        { n: "Under Pressure", a: "David Bowie & Queen", y: 1981, id: "a01QQZyl-_I" },
        { n: "Dancing Queen", a: "ABBA", y: 1976, id: "xFrGuyw1V8s" },
        { n: "Stayin' Alive", a: "Bee Gees", y: 1977, id: "I_izvAbhExY" },
        { n: "Rolling in the Deep", a: "Adele", y: 2011, id: "rYEDA3JcQqw" },
        { n: "Uptown Funk", a: "Bruno Mars", y: 2014, id: "OPf0YbXqDm0" },
        { n: "Blinding Lights", a: "The Weeknd", y: 2019, id: "4NRXx6U8ABQ" }
    ];

    let players = [];
    let cur = 0;
    let deck = [];
    let currentSong = null;
    let currentModeText = "All Time"; 
    
    document.addEventListener('DOMContentLoaded', () => {
        const decadeInput = document.getElementById('decadeFilter');
        const artistInput = document.getElementById('artistFilter');
        const customUrlInput = document.getElementById('customUrl');

        artistInput.addEventListener('input', function() {
            if (this.value.trim() !== "") {
                decadeInput.value = 'all';
                customUrlInput.value = '';
                customPlaylistId = null;
                checkFilters();
            }
        });

        decadeInput.addEventListener('change', function() {
            if (this.value !== 'all') {
                artistInput.value = '';
                customUrlInput.value = '';
                customPlaylistId = null;
                checkFilters();
            }
        });

        customUrlInput.addEventListener('input', function() {
            const btn = document.getElementById('applyCustomBtn');
            if (this.value.trim().includes('list=')) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
                customPlaylistId = null;
            }
        });
    });

    function applyCustomPlaylist() {
        const url = document.getElementById('customUrl').value;
        const match = url.match(/[&?]list=([^&]+)/);
        if (match && match[1]) {
            customPlaylistId = match[1];
            document.getElementById('customStatus').innerText = "Playlist detected!";
            document.getElementById('customStatus').style.color = "#1DB954";
            document.getElementById('decadeFilter').value = 'all';
            document.getElementById('artistFilter').value = '';
            document.getElementById('startBtn').classList.remove('hidden');
        }
    }

    function saveState() {
        const state = {
            players: players,
            cur: cur,
            deck: deck,
            gameStarted: !document.getElementById('game').classList.contains('hidden'),
            modeText: currentModeText,
            customPlaylistId: customPlaylistId
        };
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch(e) {}
    }

    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        populateArtistList(); 
        if(!raw) return;
        
        try {
            const state = JSON.parse(raw);
            players = state.players || [];
            cur = state.cur || 0;
            deck = state.deck || [];
            currentModeText = state.modeText || "All Time";
            customPlaylistId = state.customPlaylistId || null;
            
            if(players.length > 0) renderPlayers();

            if(state.gameStarted && players.length > 0) {
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('game').classList.remove('hidden');
                document.getElementById('modeInfo').innerText = `Game Mode: ${currentModeText}`;
                updateBoard();
                updateDeckInfo();
                if (deck.length > 0) deck = shuffle(deck);
            }
        } catch(e) {}
    }

    function populateArtistList() {
        const artists = [...new Set(playlist.map(s => s.a))].sort();
        const dataList = document.getElementById('artistList');
        dataList.innerHTML = artists.map(a => `<option value="${a}">`).join('');
    }

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function addPlayer() {
        let n = document.getElementById('pName').value.trim();
        if(n) {
            players.push({ name: n, score: 0 });
            document.getElementById('pName').value = '';
            renderPlayers();
            saveState(); 
        }
    }

    function renderPlayers() {
        let html = players.map(p => `<span class="score-badge">${p.name}</span>`).join(' ');
        document.getElementById('pList').innerHTML = html;
        if(players.length > 0) document.getElementById('startBtn').classList.remove('hidden');
    }

    function checkFilters() {
        if (customPlaylistId) {
            document.getElementById('filterCount').innerText = "Playlist Ready";
            document.getElementById('filterCount').style.color = "#1DB954";
            return;
        }
        const matches = getFilteredSongs();
        const msg = document.getElementById('filterCount');
        msg.innerText = matches.length === 0 ? "0 matches" : `${matches.length} songs`;
        msg.style.color = matches.length === 0 ? "#e74c3c" : "#1DB954";
    }

    function getFilteredSongs() {
        const decade = document.getElementById('decadeFilter').value;
        const artist = document.getElementById('artistFilter').value.toLowerCase().trim();
        return playlist.filter(song => {
            if (artist) return song.a.toLowerCase().includes(artist);
            if (decade !== 'all') {
                const y = parseInt(song.y);
                if (decade === '60s') return y >= 1960 && y < 1970;
                if (decade === '70s') return y >= 1970 && y < 1980;
                if (decade === '80s') return y >= 1980 && y < 1990;
                if (decade === '90s') return y >= 1990 && y < 2000;
                if (decade === '00s') return y >= 2000 && y < 2010;
                if (decade === '10s') return y >= 2010;
            }
            return true;
        });
    }

    function startGame() {
        if(!isPlayerReady) return;
        
        if (customPlaylistId) {
            currentModeText = "Custom Playlist";
        } else {
            let finalPool = getFilteredSongs();
            if (finalPool.length === 0) return;
            const decade = document.getElementById('decadeFilter').value;
            const artist = document.getElementById('artistFilter').value;
            currentModeText = artist ? `Artist - ${artist}` : (decade !== 'all' ? `Decade - ${decade}` : "All Time");
            deck = shuffle(finalPool).slice(0, 100);
        }

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        document.getElementById('modeInfo').innerText = `Game Mode: ${currentModeText}`;

        updateBoard();
        updateDeckInfo();
        saveState(); 
    }

    function updateDeckInfo() {
        document.getElementById('deckInfo').innerText = customPlaylistId ? `YouTube Source` : `Songs Left: ${deck.length}`;
    }

    function updateBoard() {
        document.getElementById('turnTxt').innerText = players[cur].name + "'s Turn";
        document.getElementById('sb').innerHTML = "<b>SCOREBOARD</b><br>" + 
            players.map(p => `${p.name}: ${p.score}`).join(' | ');
    }

    function playRandomSong() {
        if(!isPlayerReady) return;

        document.getElementById('results').classList.add('hidden');
        document.getElementById('statusText').innerText = "Loading Song...";
        
        if(player && player.stopVideo) player.stopVideo();

        if (customPlaylistId) {
            if (!isPlaylistStarted) {
                // First load
                player.cuePlaylist({
                    list: customPlaylistId,
                    listType: 'playlist',
                    index: 0,
                    startSeconds: 40,
                    suggestedQuality: 'small'
                });
                // Wait briefly for cueing then play & shuffle
                setTimeout(() => {
                    player.playVideo();
                    player.setShuffle(true);
                    player.nextVideo();
                }, 500);
                isPlaylistStarted = true;
            } else {
                player.nextVideo();
            }
            document.getElementById('loadBtn').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('pauseBtn').innerText = "‚ñ∂ Play";
        } else {
            if(deck.length === 0) deck = shuffle(getFilteredSongs()).slice(0, 100); 
            currentSong = deck.pop();
            updateDeckInfo();
            saveState(); 

            player.loadVideoById({
                videoId: currentSong.id, 
                startSeconds: 40,
                suggestedQuality: 'small'
            });
            document.getElementById('loadBtn').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('pauseBtn').innerText = "‚ñ∂ Play";
        }
    }

    function toggleAudio() {
        let s = player.getPlayerState();
        if(s === YT.PlayerState.PLAYING) { 
            player.pauseVideo(); 
        } else { 
            player.playVideo(); 
        }
    }

    function showResults() {
        player.pauseVideo();
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('statusText').innerText = "";
        
        const songLink = document.getElementById('songLink');
        
        if (customPlaylistId) {
            const data = player.getVideoData();
            const fullTitle = data.title || "Unknown Title";
            let artist = data.author || "Various";
            let songName = fullTitle;
            let year = "---";

            if (fullTitle.includes(" - ")) {
                const parts = fullTitle.split(" - ");
                artist = parts[0].trim();
                songName = parts[1].trim();
            }
            const yearMatch = fullTitle.match(/\b(19|20)\d{2}\b/);
            if (yearMatch) year = yearMatch[0];

            document.getElementById('resTitle').innerText = songName;
            document.getElementById('resArtist').innerText = "By: " + artist;
            document.getElementById('resYear').innerText = year;
            
            // Set link for custom playlist
            songLink.href = player.getVideoUrl();
        } else {
            document.getElementById('resTitle').innerText = currentSong.n;
            document.getElementById('resArtist').innerText = "By: " + currentSong.a;
            document.getElementById('resYear').innerText = currentSong.y;
            
            // Set link for static playlist
            songLink.href = `https://www.youtube.com/watch?v=${currentSong.id}`;
        }
    }

    function submitTurn() {
        let checks = document.querySelectorAll('.sc-check:checked').length;
        if(checks >= 2) players[cur].score++;
        
        if(players[cur].score >= 10) {
            document.getElementById('game').classList.add('hidden');
            document.getElementById('winScreen').classList.remove('hidden');
            document.getElementById('winnerName').innerText = players[cur].name + "!";
            localStorage.removeItem(STORAGE_KEY); 
            return;
        }

        document.querySelectorAll('.sc-check').forEach(c => c.checked = false);
        cur = (cur + 1) % players.length;
        
        if (!customPlaylistId) player.stopVideo();
        document.getElementById('results').classList.add('hidden');
        document.getElementById('loadBtn').classList.remove('hidden');
        document.getElementById('statusText').innerText = "";
        
        updateBoard();
        saveState(); 
    }

    function triggerReset() {
        openModal("Reset Game?", "Scores and current deck will be cleared.", () => {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        });
    }

    loadState();
</script>
</body>
</html>
